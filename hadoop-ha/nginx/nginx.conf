events {
    worker_connections 1024;
}

http {
    server {
        listen 80;
        server_name localhost;
        
        # NameNode1 Web UI
        location /namenode1/ {
            proxy_pass http://namenode1:9870/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # NameNode2 Web UI
        location /namenode2/ {
            proxy_pass http://namenode2:9870/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # YARN Web UI
        location /yarn/ {
            proxy_pass http://resourcemanager1:8088/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # DataNode1 Web UI
        location /datanode1/ {
            proxy_pass http://datanode1:9864/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # DataNode2 Web UI
        location /datanode2/ {
            proxy_pass http://datanode2:9864/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # DataNode3 Web UI
        location /datanode3/ {
            proxy_pass http://datanode3:9864/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Root path redirect to NameNode1
        location = / {
            return 301 /namenode1/;
        }
    }
}

# TCP proxy configuration for RPC
stream {
    # NameNode HA load balancing
    upstream namenode_ha {
        server namenode1:9820 max_fails=1 fail_timeout=30s;
        server namenode2:9820 max_fails=1 fail_timeout=30s backup;
    }
    
    # NameNode RPC port - HA load balancing
    server {
        listen 9820;
        proxy_pass namenode_ha;
        proxy_timeout 30s;
        proxy_connect_timeout 5s;
    }
    
    # NameNode2 RPC port - Direct access to standby
    server {
        listen 9821;
        proxy_pass namenode2:9820;
    }
    
    # DataNode1 RPC port
    server {
        listen 9866;
        proxy_pass datanode1:9866;
    }
    
    # DataNode2 RPC port
    server {
        listen 9867;
        proxy_pass datanode2:9866;
    }
    
    # DataNode3 RPC port
    server {
        listen 9868;
        proxy_pass datanode3:9866;
    }
    
    # ResourceManager1 RPC port
    server {
        listen 8030;
        proxy_pass resourcemanager1:8030;
    }
    
    # ResourceManager2 RPC port
    server {
        listen 8031;
        proxy_pass resourcemanager2:8030;
    }
} 