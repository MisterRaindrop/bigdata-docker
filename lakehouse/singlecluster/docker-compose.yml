services:
  lakehouse:
    build:
      context: .
      dockerfile: Dockerfile
    image: lakehouse-allinone:latest
    container_name: lakehouse
    hostname: lakehouse
    environment:
      - HDFS_NN_URI=hdfs://localhost:8020
      - METASTORE_DB_USER=hive
      - METASTORE_DB_PASS=
      - METASTORE_DB_NAME=metastore
      - S3_ENDPOINT=http://lakehouse:9100
      - S3_ACCESS_KEY=admin
      - S3_SECRET_KEY=password
      - WAREHOUSE_S3=s3a://warehouse
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=password
    ports:
      - "9870:9870"   # HDFS NN UI
      - "9864:9864"   # HDFS DN
      - "9083:9083"   # Hive Metastore
      - "10000:10000" # HiveServer2
      - "9100:9100"   # MinIO API
      - "9200:9200"   # MinIO Console
      - "7077:7077"   # Spark master
      - "8080:8080"   # Spark master UI
      - "18080:18080" # Spark history
      - "8181:8181"   # Reserved for Polaris/REST Catalog
    volumes:
      - ./data/hdfs:/data/hdfs
      - ./data/metastore-db:/data/metastore-db
      - ./data/warehouse:/data/warehouse
      - ./data/logs:/var/log/lakehouse
      - ./:/workspace
    command: ["tail","-f","/dev/null"]
    networks:
      - share-enterprise-ci

  polaris:
    build:
      context: ./thirdparty/apache-polaris
    image: apache-polaris:1.2.0-local
    depends_on:
      - lakehouse
    environment:
      JAVA_DEBUG: "false"
      JAVA_DEBUG_PORT: "*:5005"
      AWS_REGION: us-west-2
      AWS_ACCESS_KEY_ID: admin
      AWS_SECRET_ACCESS_KEY: password
      AWS_ENDPOINT_URL: http://lakehouse:9100
      AWS_S3_PATH_STYLE_ACCESS: "true"
      AWS_S3_USE_PATH_STYLE_ACCESS: "true"
      AWS_S3_FORCE_PATH_STYLE: "true"
      POLARIS_BOOTSTRAP_CREDENTIALS: POLARIS,${ROOT_CLIENT_ID:-root},${ROOT_CLIENT_SECRET:-s3cr3t}
      polaris.realm-context.realms: ${POLARIS_REALM:-POLARIS}
      quarkus.otel.sdk.disabled: "true"
    ports:
      - "18181:8181"   # Polaris API
      - "18182:8182"   # Polaris management/health
      # - "15005:5005" # Uncomment to enable remote debug
    command: ["tail","-f","/dev/null"]
    networks:
      - share-enterprise-ci
    healthcheck:
      test: ["CMD", "curl", "http://localhost:8182/q/health"]
      interval: 3s
      timeout: 10s
      retries: 10
      start_period: 10s

networks:
  share-enterprise-ci:
    external: true

